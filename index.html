<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Celery Tester Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #2b5876, #4e4376);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}
.container {
    width: 380px;
    background: white;
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 8px 28px rgba(0,0,0,0.25);
    animation: fadeIn .45s ease;
}
h2,h3 { text-align: center; margin-bottom: 22px; color: #333; }
input {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    text-align: center;
}
button {
    width: 100%;
    padding: 12px;
    margin-top: 18px;
    background: #4e4376;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: .25s;
}
button:hover { background: #2b5876; }
.link {
    text-align: center;
    margin-top: 15px;
    color: #4e4376;
    cursor: pointer;
    font-size: 14px;
}
.error { color: red; text-align: center; margin-top: 12px; }
.success { color: green; text-align: center; margin-top: 12px; }
#passwordStrength { margin-top: 8px; text-align: center; font-size: 14px; }
@keyframes fadeIn { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
.adminTable { width:100%; border-collapse: collapse; margin-top:15px; }
.adminTable th, .adminTable td { padding:8px; border-bottom:1px solid #ddd; font-size:14px; }
.smallButton { padding:5px 8px; margin:2px; font-size:12px; border-radius:5px; cursor:pointer; border:none; color:white; }
.deleteBtn { background: #c0392b; }
.resetBtn { background: #2980b9; }
</style>
</head>
<body>

<!-- REGISTER -->
<div class="container" id="registerBox">
    <h2>Create Account</h2>
    <input id="regUser" placeholder="Username">
    <input id="regPass" type="password" placeholder="Password">
    <div id="passwordStrength">üîí Make sure it's secure!</div>
    <input id="regKey" placeholder="Invite Key">
    <button id="regBtn">Register</button>
    <div id="regMsg"></div>
    <div class="link" onclick="showLogin()">Already registered? Login</div>
</div>

<!-- LOGIN -->
<div class="container" id="loginBox" style="display:none;">
    <h2>Login</h2>
    <input id="logUser" placeholder="Username">
    <input id="logPass" type="password" placeholder="Password">
    <button id="logBtn">Login</button>
    <div id="logMsg"></div>
    <div class="link" onclick="showRegister()">Create new account</div>
</div>

<!-- DOWNLOAD -->
<div class="container" id="downloadBox" style="display:none;">
    <h2>Welcome!</h2>
    <p style="text-align:center;" id="welcomeMsg">You're logged in.</p>
    <button onclick="downloadFile()">Download celery.zip</button>
    <div class="link" onclick="logout()">Log Out</div>
    <div class="link" onclick="openAdminPanel()" id="adminLink" style="display:none; margin-top:20px;">üîê Open Admin Panel</div>
</div>

<!-- ADMIN PANEL -->
<div class="container" id="adminBox" style="display:none; width:650px;">
    <h2>Admin Panel</h2>
    <p style="text-align:center;">Manage Registered Users Below</p>
    <table class="adminTable" id="adminTable">
        <tr><th>Username</th><th>Password Hash</th><th>Actions</th></tr>
    </table>
    <button style="background:#8e44ad; color:white; margin-top:10px;" onclick="openInviteManager()">Manage Invite Keys</button>
    <div id="loginAttemptsPanel"></div>
    <button style="background:#333; margin-top:12px;" onclick="closeAdminPanel()">Close Admin Panel</button>
</div>

<script>
// --- Elements ---
const registerBox = document.getElementById("registerBox");
const loginBox = document.getElementById("loginBox");
const downloadBox = document.getElementById("downloadBox");
const adminBox = document.getElementById("adminBox");
const adminLink = document.getElementById("adminLink");
const adminTable = document.getElementById("adminTable");
const regPass = document.getElementById("regPass");
const passwordStrength = document.getElementById("passwordStrength");
const regMsg = document.getElementById("regMsg");
const logMsg = document.getElementById("logMsg");

// --- Admins ---
const ADMINS = ["celeryadmin","celeryowner"];

// --- Invite keys persistence ---
const DEFAULT_KEYS = [
    "_X53Vs=o64qD","8'Vb?09Dxy<z","j9EV@t^0x678",
    "A93f!kL0xP#2","mZ7q@4Ntg$R1","Qv9*F2uE!cT8",
    "sN4#tX0G!kB7","pRm3^L9v@Qy1","Yt4$A1wB&uK6",
    "gH2!xC7p@Dq5","Wm8#zV3s!Eo9","Kc6@jP0r$Hn4",
    "bF5!uQ2y@MZ7"
];
let savedKeys = JSON.parse(localStorage.getItem("VALID_KEYS")||"null");
let VALID_KEYS = savedKeys || [...DEFAULT_KEYS];

// Load used invites
let usedInvites = JSON.parse(localStorage.getItem("used_invites")||"[]");
VALID_KEYS = VALID_KEYS.filter(k => !usedInvites.includes(k));

// --- Page switching ---
function showLogin(){registerBox.style.display="none"; loginBox.style.display="block";}
function showRegister(){loginBox.style.display="none"; registerBox.style.display="block";}

// --- Password strength ---
regPass.addEventListener("input",()=>{
    const p=regPass.value; let score=0;
    if(p.length>=8)score++; if(/[A-Z]/.test(p))score++; if(/[0-9]/.test(p))score++; if(/[^A-Za-z0-9]/.test(p))score++;
    if(!p)passwordStrength.innerHTML="üîí Make sure it's secure!";
    else if(score<=1)passwordStrength.innerHTML="üî¥ Weak";
    else if(score===2)passwordStrength.innerHTML="üü° Medium";
    else passwordStrength.innerHTML="üü¢ Strong ‚úî";
});

// --- SHA-256 hash ---
async function hash(text){
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
    return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

// --- Track login attempts ---
function logLoginAttempt(username, success){
    let attempts = JSON.parse(localStorage.getItem("login_attempts")||"[]");
    attempts.push({
        username: username,
        success: success,
        time: new Date().toLocaleString()
    });
    localStorage.setItem("login_attempts", JSON.stringify(attempts));
}

// --- Register ---
document.getElementById("regBtn").addEventListener("click", async ()=>{
    const user=document.getElementById("regUser").value.trim();
    const pass=document.getElementById("regPass").value.trim();
    const key=document.getElementById("regKey").value.trim();
    regMsg.innerHTML=""; regMsg.className="";
    if(!user||!pass||!key){regMsg.className="error"; regMsg.innerHTML="All fields required."; return;}
    if(!VALID_KEYS.includes(key)){regMsg.className="error"; regMsg.innerHTML="Invalid or already-used invite key."; return;}
    if(localStorage.getItem("user_"+user)){regMsg.className="error"; regMsg.innerHTML="Username already taken."; return;}
    const hashed = await hash(pass);
    localStorage.setItem("user_"+user,hashed);
    localStorage.setItem("invite_user_"+key,user);
    usedInvites.push(key); localStorage.setItem("used_invites",JSON.stringify(usedInvites));
    VALID_KEYS = VALID_KEYS.filter(k=>k!==key);
    localStorage.setItem("VALID_KEYS", JSON.stringify(VALID_KEYS));
    regMsg.className="success"; regMsg.innerHTML="Account created! Redirecting...";
    setTimeout(showLogin,1200);
});

// --- Login ---
document.getElementById("logBtn").addEventListener("click", async () => {
    const user=document.getElementById("logUser").value.trim();
    const pass=document.getElementById("logPass").value.trim();
    logMsg.innerHTML=""; logMsg.className="";
    if(!user||!pass){logMsg.className="error"; logMsg.innerHTML="Enter username and password."; return;}
    const storedHash=localStorage.getItem("user_"+user);
    if(!storedHash){logLoginAttempt(user,false); logMsg.className="error"; logMsg.innerHTML="Incorrect username or password."; return;}
    const inputHash=await hash(pass);
    if(inputHash!==storedHash){logLoginAttempt(user,false); logMsg.className="error"; logMsg.innerHTML="Incorrect username or password."; return;}
    logLoginAttempt(user,true);
    localStorage.setItem("loggedInUser",user);
    logMsg.className="success"; logMsg.innerHTML="Login successful!";
    setTimeout(()=>{
        loginBox.style.display="none";
        downloadBox.style.display="block";
        adminLink.style.display = ADMINS.includes(user)?"block":"none";
        document.getElementById("welcomeMsg").innerText = "Welcome, " + user + "!";
    },300);
});

// --- Auto login ---
window.onload = ()=>{
    const user=localStorage.getItem("loggedInUser");
    if(user){
        registerBox.style.display="none";
        loginBox.style.display="none";
        downloadBox.style.display="block";
        adminLink.style.display=ADMINS.includes(user)?"block":"none";
        document.getElementById("welcomeMsg").innerText = "Welcome, " + user + "!";
    }
};

// --- Logout ---
function logout(){localStorage.removeItem("loggedInUser"); downloadBox.style.display="none"; loginBox.style.display="block";}

// --- Download ---
function downloadFile(){window.location.href="celery.zip";}

// --- Admin Panel ---
function openAdminPanel(){
    const user=localStorage.getItem("loggedInUser");
    if(!ADMINS.includes(user)) return alert("Access denied.");
    adminBox.style.display="block"; downloadBox.style.display="none";
    loadAdminTable();
    loadLoginAttempts();
}
function closeAdminPanel(){adminBox.style.display="none"; downloadBox.style.display="block";}
function loadAdminTable(){
    adminTable.innerHTML=`<tr><th>Username</th><th>Password Hash</th><th>Actions</th></tr>`;
    for(let key in localStorage){
        if(!key.startsWith("user_")) continue;
        const user=key.replace("user_",""), hash=localStorage.getItem(key);
        adminTable.innerHTML+=`<tr>
        <td>${user}</td>
        <td style="font-size:12px;">${hash}</td>
        <td>
        <button class="smallButton deleteBtn" onclick="deleteUser('${user}')">Delete</button>
        <button class="smallButton resetBtn" onclick="resetPassword('${user}')">Reset PW</button>
        </td></tr>`;
    }
}
function deleteUser(user){localStorage.removeItem("user_"+user); loadAdminTable();}
async function resetPassword(user){
    const newPass=prompt("New password:"); if(!newPass) return;
    const hashed=await hash(newPass);
    localStorage.setItem("user_"+user,hashed); loadAdminTable();
}

// --- Invite Key Manager ---
function openInviteManager() {
    let manager = document.getElementById("inviteManager");
    if(!manager){
        manager=document.createElement("div");
        manager.id="inviteManager";
        manager.innerHTML=`
            <h3 style="text-align:center;">Invite Keys Manager</h3>
            <table class="adminTable" id="inviteTable">
                <tr><th>Key</th><th>Status</th><th>Used By</th><th>Actions</th></tr>
            </table>
            <div style="margin-top:12px;text-align:center;">
                <button onclick="generateNewKeys()">Generate New Keys</button>
            </div>
            <hr style="margin-top:15px;">
        `;
        adminBox.appendChild(manager);
    }
    loadInviteTable();
}

function loadInviteTable() {
    const inviteTable = document.getElementById("inviteTable");
    const used = JSON.parse(localStorage.getItem("used_invites")||"[]");
    inviteTable.innerHTML=`<tr><th>Key</th><th>Status</th><th>Used By</th><th>Actions</th></tr>`;
    const allKeys = [...VALID_KEYS,...used];
    allKeys.forEach(k=>{
        const isUsed = used.includes(k);
        const usedBy = localStorage.getItem("invite_user_"+k) || "-";
        inviteTable.innerHTML+=`<tr>
            <td>${k}</td>
            <td>${isUsed?"‚úÖ Used":"‚ùå Unused"}</td>
            <td>${usedBy}</td>
            <td>
                ${isUsed?`<button class="smallButton resetBtn" onclick="restoreKey('${k}')">Restore</button>`:""}
                <button class="smallButton deleteBtn" onclick="deleteKey('${k}')">Delete</button>
            </td>
        </tr>`;
    });
}

function generateRandomKey(length=12){
    const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+";
    let key=""; for(let i=0;i<length;i++) key+=chars[Math.floor(Math.random()*chars.length)];
    return key;
}

function generateNewKeys(){
    const count=parseInt(prompt("How many keys to generate?","5"));
    if(!count||count<1) return;
    for(let i=0;i<count;i++){
        const k=generateRandomKey();
        VALID_KEYS.push(k);
    }
    localStorage.setItem("VALID_KEYS", JSON.stringify(VALID_KEYS));
    loadInviteTable();
    alert(count+" new keys generated!");
}

function deleteKey(k){
    if(confirm("Delete key "+k+"?")) {
        VALID_KEYS = VALID_KEYS.filter(key=>key!==k);
        localStorage.setItem("VALID_KEYS", JSON.stringify(VALID_KEYS));
        let used=JSON.parse(localStorage.getItem("used_invites")||"[]");
        used=used.filter(key=>key!==k);
        localStorage.setItem("used_invites",JSON.stringify(used));
        localStorage.removeItem("invite_user_"+k);
        loadInviteTable();
    }
}

function restoreKey(k){
    if(confirm("Restore key "+k+"? It will be usable again.")){
        let used=JSON.parse(localStorage.getItem("used_invites")||"[]");
        used=used.filter(key=>key!==k);
        localStorage.setItem("used_invites",JSON.stringify(used));
        if(!VALID_KEYS.includes(k)) {
            VALID_KEYS.push(k);
            localStorage.setItem("VALID_KEYS", JSON.stringify(VALID_KEYS));
        }
        localStorage.removeItem("invite_user_"+k);
        loadInviteTable();
    }
}

// --- Login attempts display ---
function loadLoginAttempts(){
    const attempts = JSON.parse(localStorage.getItem("login_attempts")||"[]");
    let html = `<h3 style="text-align:center; margin-top:20px;">Login Attempts</h3>
                <table class="adminTable">
                    <tr><th>Username</th><th>Success</th><th>Time</th></tr>`;
    attempts.forEach(a=>{
        html += `<tr>
                    <td>${a.username}</td>
                    <td>${a.success ? "‚úÖ" : "‚ùå"}</td>
                    <td>${a.time}</td>
                 </tr>`;
    });
    html += `</table>`;
    
    let panel = document.getElementById("loginAttemptsPanel");
    if(!panel){
        panel = document.createElement("div");
        panel.id = "loginAttemptsPanel";
        adminBox.appendChild(panel);
    }
    panel.innerHTML = html;
}
</script>
</body>
</html>
