<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Celery Tester Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #2b5876, #4e4376);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}
.container {
    width: 380px;
    background: white;
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 8px 28px rgba(0,0,0,0.25);
    animation: fadeIn .45s ease;
}
h2,h3 { text-align: center; margin-bottom: 22px; color: #333; }
input {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    text-align: center;
}
button {
    width: 100%;
    padding: 12px;
    margin-top: 18px;
    background: #4e4376;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: .25s;
}
button:hover { background: #2b5876; }
.link {
    text-align: center;
    margin-top: 15px;
    color: #4e4376;
    cursor: pointer;
    font-size: 14px;
}
.error { color: red; text-align: center; margin-top: 12px; }
.success { color: green; text-align: center; margin-top: 12px; }
#passwordStrength { margin-top: 8px; text-align: center; font-size: 14px; }
@keyframes fadeIn { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
.adminTable { width:100%; border-collapse: collapse; margin-top:15px; }
.adminTable th, .adminTable td { padding:8px; border-bottom:1px solid #ddd; font-size:14px; }
.smallButton { padding:5px 8px; margin:2px; font-size:12px; border-radius:5px; cursor:pointer; border:none; color:white; }
.deleteBtn { background: #c0392b; }
.resetBtn { background: #2980b9; }
</style>
</head>
<body>

<!-- REGISTER -->
<div class="container" id="registerBox">
    <h2>Create Account</h2>
    <input id="regUser" placeholder="Username">
    <input id="regPass" type="password" placeholder="Password">
    <div id="passwordStrength">üîí Make sure it's secure!</div>
    <input id="regKey" placeholder="Invite Key">
    <button id="regBtn">Register</button>
    <div id="regMsg"></div>
    <div class="link" onclick="showLogin()">Already registered? Login</div>
</div>

<!-- LOGIN -->
<div class="container" id="loginBox" style="display:none;">
    <h2>Login</h2>
    <input id="logUser" placeholder="Username">
    <input id="logPass" type="password" placeholder="Password">
    <button id="logBtn">Login</button>
    <div id="logMsg"></div>
    <div class="link" onclick="showRegister()">Create new account</div>
</div>

<!-- DOWNLOAD -->
<div class="container" id="downloadBox" style="display:none;">
    <h2>Welcome!</h2>
    <p style="text-align:center;" id="welcomeMsg">You're logged in.</p>
    <button onclick="downloadFile()">Download celery.zip</button>
    <div class="link" onclick="logout()">Log Out</div>
    <div class="link" onclick="openAdminPanel()" id="adminLink" style="display:none; margin-top:20px;">üîê Open Admin Panel</div>
</div>

<!-- ADMIN PANEL -->
<div class="container" id="adminBox" style="display:none; width:650px;">
    <h2>Admin Panel</h2>
    <p style="text-align:center;">Manage Registered Users Below</p>
    <table class="adminTable" id="adminTable">
        <tr><th>Username</th><th>Actions</th></tr>
    </table>
    <button style="background:#333; margin-top:12px;" onclick="closeAdminPanel()">Close Admin Panel</button>
</div>

<script>
const registerBox = document.getElementById("registerBox");
const loginBox = document.getElementById("loginBox");
const downloadBox = document.getElementById("downloadBox");
const adminBox = document.getElementById("adminBox");
const adminLink = document.getElementById("adminLink");
const regPass = document.getElementById("regPass");
const passwordStrength = document.getElementById("passwordStrength");
const regMsg = document.getElementById("regMsg");
const logMsg = document.getElementById("logMsg");

// Admins
const ADMINS = ["celeryadmin", "celeryowner"];

// Page switching
function showLogin(){registerBox.style.display="none"; loginBox.style.display="block";}
function showRegister(){loginBox.style.display="none"; registerBox.style.display="block";}

// Password strength
regPass.addEventListener("input", ()=>{
    const p=regPass.value; let score=0;
    if(p.length>=8) score++;
    if(/[A-Z]/.test(p)) score++;
    if(/[0-9]/.test(p)) score++;
    if(/[^A-Za-z0-9]/.test(p)) score++;
    if(!p) passwordStrength.innerHTML="üîí Make sure it's secure!";
    else if(score<=1) passwordStrength.innerHTML="üî¥ Weak";
    else if(score===2) passwordStrength.innerHTML="üü° Medium";
    else passwordStrength.innerHTML="üü¢ Strong ‚úî";
});

// Register
document.getElementById("regBtn").addEventListener("click", async ()=>{
    const user=document.getElementById("regUser").value.trim();
    const pass=document.getElementById("regPass").value.trim();
    const key=document.getElementById("regKey").value.trim();
    regMsg.innerHTML=""; regMsg.className="";
    try{
        const res = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: user, password: pass, invite: key })
        });
        const data = await res.json();
        if(data.error){ regMsg.className="error"; regMsg.innerHTML=data.error; return; }
        regMsg.className="success"; regMsg.innerHTML="Account created! Redirecting...";
        setTimeout(showLogin,1200);
    }catch(e){ regMsg.className="error"; regMsg.innerHTML="Server error"; }
});

// Login
document.getElementById("logBtn").addEventListener("click", async ()=>{
    const user=document.getElementById("logUser").value.trim();
    const pass=document.getElementById("logPass").value.trim();
    logMsg.innerHTML=""; logMsg.className="";
    try{
        const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: user, password: pass })
        });
        const data = await res.json();
        if(data.error){ logMsg.className="error"; logMsg.innerHTML=data.error; return; }
        logMsg.className="success"; logMsg.innerHTML="Login successful!";
        setTimeout(()=>{
            loginBox.style.display="none";
            downloadBox.style.display="block";
            adminLink.style.display = ADMINS.includes(user) ? "block" : "none";
            document.getElementById("welcomeMsg").innerText = "Welcome, " + user + "!";
            sessionStorage.setItem("loggedInUser", user);
        },300);
    }catch(e){ logMsg.className="error"; logMsg.innerHTML="Server error"; }
});

// Logout
function logout(){
    sessionStorage.removeItem("loggedInUser");
    downloadBox.style.display="none"; loginBox.style.display="block";
}

// Download
function downloadFile(){window.location.href="/celery.zip";}

// Admin panel
function openAdminPanel(){
    const user = sessionStorage.getItem("loggedInUser");
    if(!ADMINS.includes(user)) return alert("Access denied.");
    adminBox.style.display="block"; downloadBox.style.display="none";
    loadAdminTable();
}
function closeAdminPanel(){adminBox.style.display="none"; downloadBox.style.display="block";}

async function loadAdminTable(){
    const table = document.getElementById("adminTable");
    try{
        const res = await fetch("/api/admin/users");
        const users = await res.json();
        table.innerHTML=`<tr><th>Username</th><th>Actions</th></tr>`;
        for(let user in users){
            table.innerHTML += `<tr>
                <td>${user}</td>
                <td>
                    <button class="smallButton deleteBtn" onclick="deleteUser('${user}')">Delete</button>
                    <button class="smallButton resetBtn" onclick="resetPassword('${user}')">Reset PW</button>
                </td>
            </tr>`;
        }
    }catch(e){ table.innerHTML=`<tr><td colspan="2">Error loading users</td></tr>`; }
}

async function deleteUser(user){
    if(!confirm("Delete "+user+"?")) return;
    await fetch("/api/admin/delete", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username:user}) });
    loadAdminTable();
}

async function resetPassword(user){
    const newPass = prompt("New password for "+user+":");
    if(!newPass) return;
    await fetch("/api/admin/reset", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username:user, password:newPass}) });
    alert("Password reset!");
}
</script>
</body>
</html>
